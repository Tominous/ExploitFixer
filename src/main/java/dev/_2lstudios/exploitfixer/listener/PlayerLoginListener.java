package dev._2lstudios.exploitfixer.listener;

import java.net.InetAddress;

import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerLoginEvent;

import dev._2lstudios.exploitfixer.exploit.ExploitPlayer;
import dev._2lstudios.exploitfixer.managers.ExploitPlayerManager;
import dev._2lstudios.exploitfixer.managers.ModuleManager;
import dev._2lstudios.exploitfixer.modules.NotificationsModule;
import dev._2lstudios.exploitfixer.modules.ConnectionModule;
import dev._2lstudios.exploitfixer.modules.ItemsFixModule;
import dev._2lstudios.exploitfixer.modules.MessagesModule;

public class PlayerLoginListener implements Listener {
	private ExploitPlayerManager exploitPlayerManager;
	private NotificationsModule notificationsModule;
	private MessagesModule messagesModule;
	private ConnectionModule connectionModule;
	private ItemsFixModule itemsFixModule;

	PlayerLoginListener(ModuleManager moduleManager) {
		this.exploitPlayerManager = moduleManager.getExploitPlayerManager();
		this.connectionModule = moduleManager.getConnectionModule();
		this.notificationsModule = moduleManager.getNotificationsModule();
		this.messagesModule = moduleManager.getMessagesModule();
		this.itemsFixModule = moduleManager.getItemsFixModule();
	}

	@EventHandler(priority = EventPriority.LOW, ignoreCancelled = true)
	public void onPlayerLogin(PlayerLoginEvent event) {
		Player player = event.getPlayer();
		String playerName = player.getName();
		InetAddress address = event.getAddress();

		if (connectionModule.isNullAddressEnabled() && address == null) {
			ExploitPlayer exploitPlayer = exploitPlayerManager.get(player);
			String nullAddressKickMessage = messagesModule.getKickMessage("nulladdress", exploitPlayer.getLocale());

			event.setKickMessage(nullAddressKickMessage);
			event.setResult(PlayerLoginEvent.Result.KICK_OTHER);
		}

		if (player.hasPermission("exploitfixer.notifications")) {
			notificationsModule.setNotifications(playerName, true);
		}

		// Get the items fix bypass permission
		String itemsFixBypassPermission = itemsFixModule.getBypassPermission();

		// Check if the permission is configured
		if (itemsFixBypassPermission != null) {
			// Set the player as bypassing items fix check
			exploitPlayerManager.get(player).setBypassItemsFix(player.hasPermission(itemsFixBypassPermission));
		}
	}
}
