package dev._2lstudios.exploitfixer.utils;

import java.nio.charset.StandardCharsets;
import java.util.Collection;
import java.util.List;

import org.bukkit.FireworkEffect;
import org.bukkit.Material;
import org.bukkit.block.BlockState;
import org.bukkit.entity.Player;
import org.bukkit.event.Cancellable;
import org.bukkit.inventory.InventoryHolder;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.BlockStateMeta;
import org.bukkit.inventory.meta.BookMeta;
import org.bukkit.inventory.meta.FireworkMeta;
import org.bukkit.inventory.meta.ItemMeta;

import dev._2lstudios.exploitfixer.enums.CheckItemResult;
import dev._2lstudios.exploitfixer.exploit.BukkitExploitPlayer;
import dev._2lstudios.exploitfixer.managers.ExploitPlayerManager;
import dev._2lstudios.exploitfixer.managers.ModuleManager;
import dev._2lstudios.exploitfixer.modules.ItemsFixModule;
import dev._2lstudios.exploitfixer.modules.NotificationsModule;
import dev._2lstudios.exploitfixer.modules.PacketsModule;
import dev._2lstudios.hamsterapi.hamsterplayer.HamsterPlayer;

public class ExploitUtil {
    private ExploitPlayerManager exploitPlayerManager;
    private ItemsFixModule itemsFixModule;
    private NotificationsModule notificationsModule;
    private PacketsModule packetsModule;

    public ExploitUtil(ModuleManager moduleManager) {
        this.exploitPlayerManager = moduleManager.getExploitPlayerManager();
        this.itemsFixModule = moduleManager.getItemsFixModule();
        this.notificationsModule = moduleManager.getNotificationsModule();
        this.packetsModule = moduleManager.getPacketsModule();
    }

    private CheckItemResult checkBlockState(BlockStateMeta meta) {
        if (meta.hasBlockState()) {
            BlockState blockState = meta.getBlockState();

            if (blockState instanceof InventoryHolder) {
                InventoryHolder inventoryHolder = (InventoryHolder) blockState;

                for (ItemStack item : inventoryHolder.getInventory().getContents()) {
                    if (checkItem(item) != CheckItemResult.VALID_ITEM) {
                        return CheckItemResult.INVALID_BLOCK;
                    }
                }
            }
        }

        return CheckItemResult.VALID_ITEM;
    }

    private CheckItemResult checkBook(BookMeta meta) {
        String title = meta.getTitle();

        if (title != null && title.length() > 32) {
            return CheckItemResult.INVALID_BOOK_TITLE;
        }

        String author = meta.getAuthor();

        if (author != null && author.length() > 16) {
            return CheckItemResult.INVALID_BOOK_AUTHOR;
        }

        if (meta.getPageCount() > 50) {
            return CheckItemResult.INVALID_BOOK_PAGES;
        }

        int dataBytesBook = packetsModule.getDataMaxSizeBook();

        for (String page : meta.getPages()) {
            int pageBytes = page.getBytes(StandardCharsets.UTF_8).length;

            if (pageBytes > dataBytesBook) {
                return CheckItemResult.INVALID_BOOK_SIZE;
            }
        }

        return CheckItemResult.VALID_ITEM;
    }

    private CheckItemResult checkFirework(FireworkMeta meta) {
        try {
            if (meta.getPower() > 3) {
                return CheckItemResult.INVALID_FIREWORK_POWER;
            }
        } catch (NullPointerException ex) {
            // Power can sometimes be null
        }

        // Check if it has effects
        if (meta.hasEffects()) {
            // Get the allowed flags count
            int allowedFlags = packetsModule.getDataMaxFireworkFlags();

            if (meta.getEffectsSize() > allowedFlags) {
                // Check for the amount of effects
                return CheckItemResult.INVALID_FIREWORK_EFFECTS;
            }

            for (FireworkEffect effect : meta.getEffects()) {
                if (effect.getColors().size() > allowedFlags) {
                    // Check for too many colors
                    return CheckItemResult.INVALID_FIREWORK_COLORS;
                }

                if (effect.getFadeColors().size() > allowedFlags) {
                    // Check for too many fade colors
                    return CheckItemResult.INVALID_FIREWORK_FADE_COLORS;
                }
            }
        }

        return CheckItemResult.VALID_ITEM;
    }

    public CheckItemResult checkItem(ItemStack item) {
        try {
            if (item != null && item.hasItemMeta()) {
                ItemMeta itemMeta = item.getItemMeta();

                if (itemMeta != null) {
                    String displayName = itemMeta.getDisplayName();

                    if (displayName != null && displayName.length() > 1536) {
                        return CheckItemResult.INVALID_ITEM_NAME;
                    }

                    List<String> lore = itemMeta.getLore();

                    if (lore != null && lore.size() > 64) {
                        return CheckItemResult.INVALID_ITEM_LORE;
                    }

                    if (itemMeta instanceof BookMeta) {
                        return checkBook((BookMeta) itemMeta);
                    } else if (itemMeta instanceof BlockStateMeta) {
                        return checkBlockState((BlockStateMeta) itemMeta);
                    } else if (itemMeta instanceof FireworkMeta) {
                        return checkFirework((FireworkMeta) itemMeta);
                    }
                }
            }
        } catch (IllegalArgumentException ex) {
            return CheckItemResult.INVALID_ITEM;
        }

        return CheckItemResult.VALID_ITEM;
    }

    public boolean checkSign(String[] linesString) {
        int dataBytesSign = packetsModule.getDataMaxSizeSign();

        if (linesString != null && dataBytesSign > 0) {
            if (linesString.length > 4) {
                return true;
            } else {
                for (String line : linesString) {
                    if (line.getBytes(StandardCharsets.UTF_8).length > dataBytesSign) {
                        return false;
                    }
                }
            }
        }

        return true;
    }

    public String clearIfBlacklisted(ItemStack itemStack) {
        Collection<String> blacklist = itemsFixModule.getBlacklist();
        String materialName = itemStack.getType().toString();

        if (blacklist != null && blacklist.contains(materialName)) {
            itemStack.setType(Material.AIR);
            itemStack.setItemMeta(null);
            return materialName;
        }

        return null;
    }

    public void addVls(Cancellable event, HamsterPlayer hamsterPlayer, Player player,
            double vls, String category) {
        if (vls > 0) {
            BukkitExploitPlayer exploitPlayer = exploitPlayerManager.get(player);

            exploitPlayer.addVls(event, null, hamsterPlayer, packetsModule, vls, category);
        }
    }

    public void cancelExploit(Cancellable event, HamsterPlayer hamsterPlayer, Player player,
            String reason, double vls, String category) {
        notificationsModule.debug(reason);
        event.setCancelled(true);

        addVls(event, hamsterPlayer, player, vls, category);
    }
}